name: Cross-Compile and Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release Tag'
        required: false
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - windows/amd64
          - windows/arm64
          - linux/amd64
          - linux/arm64
          - macos/amd64
          - macos/arm64
          - freebsd/amd64  # 只构建FreeBSD的AMD64版本
    name: Build for ${{ matrix.platform }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies (for FreeBSD only)
        if: matrix.platform == 'freebsd/amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev
          
      - name: Install cross (for FreeBSD only)
        if: matrix.platform == 'freebsd/amd64'
        run: |
          cargo install cross
          
      - name: Build project for ${{ matrix.platform }}
        run: |
          if [[ "${{ matrix.platform }}" == "freebsd/amd64" ]]; then
            # For FreeBSD, use cross for building (only AMD64)
            cross build --release -p phira-mp-server --target x86_64-unknown-freebsd
          else
            # For other platforms (Windows, Linux, macOS), use native cargo build
            cargo build --release -p phira-mp-server
          fi

      - name: Archive build artifact
        run: |
          mkdir -p build_output/${{ matrix.platform }}
          if [[ "${{ matrix.platform }}" == "freebsd/amd64" ]]; then
            # For FreeBSD, copy the artifact from the cross target directory
            cp target/x86_64-unknown-freebsd/release/phira-mp-server build_output/${{ matrix.platform }}/
          else
            # For other platforms, copy from the default release directory
            cp target/release/phira-mp-server build_output/${{ matrix.platform }}/
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.platform }}
          path: build_output/${{ matrix.platform }}

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: linux-amd64  # 这里应该是合法的 artifact 名称

      - name: Set up GitHub release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag }}  # 使用手动输入的 release tag
          release_name: "Release ${{ github.event.inputs.release_tag }}"
          body: |
            Release of version ${{ github.event.inputs.release_tag }}

      - name: Rename and upload build artifacts to release
        run: |
          # For Windows/AMD64
          if [[ -f "build_output/windows/amd64/phira-mp-server" ]]; then
            mv build_output/windows/amd64/phira-mp-server build_output/windows/amd64/phira-mp-server-windows-amd64
          fi
          
          # For Windows/ARM64
          if [[ -f "build_output/windows/arm64/phira-mp-server" ]]; then
            mv build_output/windows/arm64/phira-mp-server build_output/windows/arm64/phira-mp-server-windows-arm64
          fi
          
          # For Linux/AMD64
          if [[ -f "build_output/linux/amd64/phira-mp-server" ]]; then
            mv build_output/linux/amd64/phira-mp-server build_output/linux/amd64/phira-mp-server-linux-amd64
          fi
          
          # For Linux/ARM64
          if [[ -f "build_output/linux/arm64/phira-mp-server" ]]; then
            mv build_output/linux/arm64/phira-mp-server build_output/linux/arm64/phira-mp-server-linux-arm64
          fi
          
          # For macOS/AMD64
          if [[ -f "build_output/macos/amd64/phira-mp-server" ]]; then
            mv build_output/macos/amd64/phira-mp-server build_output/macos/amd64/phira-mp-server-macos-amd64
          fi
          
          # For macOS/ARM64
          if [[ -f "build_output/macos/arm64/phira-mp-server" ]]; then
            mv build_output/macos/arm64/phira-mp-server build_output/macos/arm64/phira-mp-server-macos-arm64
          fi
          
          # For FreeBSD/AMD64
          if [[ -f "build_output/freebsd/amd64/phira-mp-server" ]]; then
            mv build_output/freebsd/amd64/phira-mp-server build_output/freebsd/amd64/phira-mp-server-freebsd-amd64
          fi

      - name: Upload renamed build artifacts to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag }}  # 确保传递 tag_name
          files: |
            build_output/windows/amd64/phira-mp-server-windows-amd64
            build_output/windows/arm64/phira-mp-server-windows-arm64
            build_output/linux/amd64/phira-mp-server-linux-amd64
            build_output/linux/arm64/phira-mp-server-linux-arm64
            build_output/macos/amd64/phira-mp-server-macos-amd64
            build_output/macos/arm64/phira-mp-server-macos-arm64
            build_output/freebsd/amd64/phira-mp-server-freebsd-amd64
