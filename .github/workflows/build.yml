name: Rust Build and Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release'
        required: false
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        arch: [amd64, arm64]
        include:
          - os: ubuntu-latest
            arch: amd64
          - os: ubuntu-latest
            arch: arm64
          - os: windows-latest
            arch: amd64
          - os: macos-latest
            arch: amd64
          - os: ubuntu-latest  # 用于构建 FreeBSD 的 Linux 环境
            arch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            sudo apt update
            sudo apt install -y pkg-config libssl-dev
            if [[ "${{ matrix.arch }}" == "amd64" ]]; then
              # Install cross for FreeBSD build
              cargo install cross
            fi
          fi

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rust-version: stable

      - name: Build phira-mp
        run: |
          cd phira-mp
          if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.arch }}" == "amd64" ]]; then
            if [[ "${{ matrix.arch }}" == "amd64" ]]; then
              # Build FreeBSD using cross
              cross build --target x86_64-unknown-freebsd --release -p phira-mp-server
            fi
          else
            # Native build for other OS and Arch
            cargo build --release -p phira-mp-server --target ${{ matrix.arch }}-${{ matrix.os }}
          fi

      - name: Rename Build Artifacts
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            if [[ "${{ matrix.arch }}" == "amd64" ]]; then
              mv target/x86_64-unknown-linux-gnu/release/phira-mp-server phira-mp-linux-x86_64
              mv target/aarch64-unknown-linux-gnu/release/phira-mp-server phira-mp-linux-arm64
            fi
          fi

          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            if [[ "${{ matrix.arch }}" == "amd64" ]]; then
              mv target/x86_64-pc-windows-gnu/release/phira-mp-server.exe phira-mp-win-x86_64.exe
            else
              mv target/aarch64-pc-windows-gnu/release/phira-mp-server.exe phira-mp-win-arm64.exe
            fi
          fi

          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            mv target/x86_64-apple-darwin/release/phira-mp-server phira-mp-macos-x86_64
          fi

          # Rename FreeBSD artifact
          if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.arch }}" == "amd64" ]]; then
            mv target/x86_64-unknown-freebsd/release/phira-mp-server phira-mp-freebsd-x86_64
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            phira-mp-linux-x86_64
            phira-mp-linux-arm64
            phira-mp-win-x86_64.exe
            phira-mp-win-arm64.exe
            phira-mp-macos-x86_64
            phira-mp-freebsd-x86_64
