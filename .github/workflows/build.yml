name: Cross-Compile and Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release Tag'
        required: false
        default: 'v1.0.0'

jobs:
  build-linux-macos-freebsd:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux-amd64
          - linux-arm64
          - macos-amd64
          - macos-arm64
          - freebsd-amd64  # Only build FreeBSD AMD64 version
    
    name: Build for ${{ matrix.platform }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          if [[ "${{ matrix.platform }}" == "freebsd-amd64" ]]; then
            sudo apt-get update
            sudo apt-get install -y pkg-config libssl-dev
          fi

      - name: Install cross
        run: |
          cargo install cross
          
      - name: Build project for ${{ matrix.platform }}
        run: |
          if [[ "${{ matrix.platform }}" == "freebsd-amd64" ]]; then
            # For FreeBSD, use cross for building (only AMD64)
            cross build --release -p phira-mp-server --target x86_64-unknown-freebsd
          else
            # For other platforms (Linux, macOS), use cross for building
            cross build --release -p phira-mp-server --target ${{ matrix.platform }}
          fi

      - name: Archive build artifact
        run: |
          mkdir -p build_output/${{ matrix.platform }}
          if [[ "${{ matrix.platform }}" == "freebsd-amd64" ]]; then
            # For FreeBSD, copy the artifact from the cross target directory
            cp target/x86_64-unknown-freebsd/release/phira-mp-server build_output/${{ matrix.platform }}/
          else
            # For other platforms, copy from the default release directory
            cp target/${{ matrix.platform }}/release/phira-mp-server build_output/${{ matrix.platform }}/
          fi

      - name: Rename Artifact
        run: |
          mv build_output/${{ matrix.platform }}/phira-mp-server build_output/${{ matrix.platform }}/phira-mp-server-${{ matrix.platform }}

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifact
          path: build_output/${{ matrix.platform }}/phira-mp-server-${{ matrix.platform }}

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        platform:
          - windows-amd64
          - windows-arm64
    
    name: Build for ${{ matrix.platform }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          choco install pkg-config
          
      - name: Build project for ${{ matrix.platform }}
        run: |
          cargo build --release -p phira-mp-server --target ${{ matrix.platform }}

      - name: Archive build artifact
        run: |
          mkdir -p build_output/${{ matrix.platform }}
          cp target/${{ matrix.platform }}/release/phira-mp-server.exe build_output/${{ matrix.platform }}/

      - name: Rename Artifact
        run: |
          mv build_output/${{ matrix.platform }}/phira-mp-server.exe build_output/${{ matrix.platform }}/phira-mp-server-${{ matrix.platform }}.exe

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifact
          path: build_output/${{ matrix.platform }}/phira-mp-server-${{ matrix.platform }}.exe

  publish:
    permissions: write-all
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag }}
    needs: [build-linux-macos-freebsd, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin/
          merge-multiple: true

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        if: ${{ success() }}
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          files: bin/*
          prerelease: false
