name: Cross-Compile and Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release Tag'
        required: true  # Make tag required during manual trigger
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - windows/amd64
          - windows/arm64
          - linux/amd64
          - linux/arm64
          - macos/amd64
          - macos/arm64
          - freebsd/amd64
    name: Build for ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies (for FreeBSD only)
        if: matrix.platform == 'freebsd/amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev

      - name: Install cross (for FreeBSD only)
        if: matrix.platform == 'freebsd/amd64'
        run: |
          cargo install cross

      - name: Build project for ${{ matrix.platform }}
        run: |
          if [[ "${{ matrix.platform }}" == "freebsd/amd64" ]]; then
            # For FreeBSD, use cross for building (only AMD64)
            cross build --release -p phira-mp-server --target x86_64-unknown-freebsd
          else
            # For other platforms (Windows, Linux, macOS), use native cargo build
            cargo build --release -p phira-mp-server
          fi

      - name: Prepare build output
        run: |
          # Ensure the output directory exists
          mkdir -p build_output/${{ matrix.platform }}

          # For FreeBSD
          if [[ "${{ matrix.platform }}" == "freebsd/amd64" ]]; then
            if [[ -f target/x86_64-unknown-freebsd/release/phira-mp-server ]]; then
              mv target/x86_64-unknown-freebsd/release/phira-mp-server build_output/${{ matrix.platform }}/phira-mp-server-freebsd-amd64
            else
              echo "FreeBSD build artifact not found"
            fi
          # For Windows
          elif [[ "${{ matrix.platform }}" == "windows/amd64" || "${{ matrix.platform }}" == "windows/arm64" ]]; then
            if [[ -f target/release/phira-mp-server.exe ]]; then
              mv target/release/phira-mp-server.exe build_output/${{ matrix.platform }}/phira-mp-server-windows-${{ matrix.platform }}.exe
            else
              echo "Windows build artifact not found"
            fi
          # For Linux and macOS
          else
            if [[ -f target/release/phira-mp-server ]]; then
              mv target/release/phira-mp-server build_output/${{ matrix.platform }}/phira-mp-server-${{ matrix.platform }}
            else
              echo "Linux/Mac build artifact not found"
            fi
          fi

      - name: Upload build artifacts
        run: |
          # Create a tarball of the build_output directory
          echo "Uploading artifacts"
          tar -czf build_output.tar.gz build_output/
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: build_output.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: List downloaded files
        run: |
          tar -xzf build_output.tar.gz
          ls -la build_output/

      - name: Create GitHub Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build_output/**/*  # Use the correct glob pattern to include all files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag the release
        run: |
          git tag ${{ github.event.inputs.release_tag }}
          git push origin ${{ github.event.inputs.release_tag }}
